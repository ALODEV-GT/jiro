<div class="min-h-screen bg-base-200 p-6">

  <h1>
    Nombre del sprint activo
  </h1>

  <!-- Columns horizontal drag and drop -->
  <div class="flex gap-6 overflow-x-auto pb-4" cdkDropList cdkDropListOrientation="horizontal"
    [cdkDropListData]="columns" (cdkDropListDropped)="dropColumn($event)" id="columns-drop-list">
    @for (column of columns; track column.id; let i = $index) {
    <div class="flex-shrink-0 w-80 bg-base-100 rounded-lg shadow-md border border-base-300 flex flex-col" cdkDrag
      [cdkDragData]="column">
      <!-- Header column -->
      <div class="p-4 border-b border-base-300 flex justify-between items-center select-none">
        <div class="flex items-center gap-2">
          <!-- Handle to move column -->
          <div cdkDragHandle class="cursor-grab p-1 rounded hover:bg-base-200 text-base-content/60"
            title="Arrastrar columna">
            <span class="text-lg leading-none">⋮⋮</span>
          </div>

          <div class="flex items-center gap-2">
            <h3 class="font-semibold text-base-content">{{ column.title }}</h3>
            <span class="badge badge-sm badge-ghost">{{ column.tasks.length }}</span>
          </div>
        </div>

        <div class="flex items-center gap-1">
          <button class="btn btn-ghost btn-xs" (click)="editColumnName(column)">
            Edit
          </button>
          @if (columns.length > 1) {
          <button class="btn btn-ghost btn-xs text-error" (click)="deleteColumn(column.id)">
            Delete
          </button>
          }
        </div>
      </div>

      <!-- Task list, drag and drop -->
      <div class="flex-1 min-h-96 p-4 space-y-3" cdkDropList [id]="'task-list-' + column.id"
        [cdkDropListData]="column.tasks" [cdkDropListConnectedTo]="taskListIds"
        (cdkDropListDropped)="dropTask($event, column.id)">
        @for (task of column.tasks; track task.id) {
        <div cdkDrag [cdkDragData]="task"
          class="bg-base-200 rounded-lg border border-base-300 shadow-sm hover:shadow-md transition-shadow cursor-grab active:cursor-grabbing group">

          <!-- Header -->
          <div class="p-4 pb-2">
            <div class="flex justify-between items-start gap-2">
              <h4 class="font-semibold text-base-content leading-snug">
                {{ task.name }}
              </h4>

              <div class="flex items-center gap-1">
                <span class="badge badge-outline badge-sm">
                  {{ task.points }} pts
                </span>

                <span class="badge badge-sm" [ngClass]="{
            'badge-error': task.priority === 'HIGH',
            'badge-warning': task.priority === 'MEDIUM',
            'badge-success': task.priority === 'LOW'
          }">
                  {{ task.priority }}
                </span>
              </div>
            </div>

            @if (task.description) {
            <p class="mt-2 text-sm text-base-content/70 line-clamp-3">
              {{ task.description }}
            </p>
            }
          </div>

          <!-- Footer -->
          <div class="px-4 py-3 border-t border-base-300 flex justify-between items-center text-sm">

            <div class="flex flex-col gap-1">
              <div class="flex items-center gap-2">
                <span class="text-xs text-base-content/60">Dev</span>
                <span class="badge badge-primary badge-sm">
                  {{ getEmployeeName(task.developerId) }}
                </span>
              </div>

              <div class="flex items-center gap-2">
                <span class="text-xs text-base-content/60">PO</span>
                <span class="badge badge-secondary badge-sm">
                  {{ getEmployeeName(task.productOwnerId) }}
                </span>
              </div>
            </div>

            <button class="btn btn-ghost btn-xs text-error opacity-0 group-hover:opacity-100 transition-opacity"
              (click)="deleteTask(column.id, task.id)" title="Eliminar historia">
              Eliminar
            </button>
          </div>

        </div>
        }
      </div>

      <!-- Footer -->
      <div class="p-4 border-t border-base-300">
        <button class="text-sm text-base-content/70 hover:text-primary w-full text-left"
          (click)="openCreateStory(column.id)">
          + Agregar historia
        </button>
      </div>
    </div>
    }

    <!-- Add new column -->
    <div class="flex-shrink-0 w-80">
      <button
        class="btn btn-ghost w-full h-32 border-2 border-dashed border-base-300 text-base-content/60 hover:border-primary hover:text-primary"
        (click)="addColumn()">
        + Agregar otra columna
      </button>
    </div>
  </div>
</div>

<!-- Modal create task -->
<dialog id="story_modal" class="modal">
  <div class="modal-box w-11/12 max-w-3xl">
    <h3 class="text-2xl font-bold mb-6">{{ editingStoryId() ? 'Editar Historia' : 'Nueva Historia' }}</h3>
    <form [formGroup]="storyForm" (ngSubmit)="saveStory()" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Nombre *</span></label>
          <input type="text" class="input input-bordered" formControlName="name" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Puntos *</span></label>
          <input type="number" class="input input-bordered" min="1" formControlName="points" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Prioridad *</span></label>
          <select class="select select-bordered" formControlName="priority">
            <option value="LOW">Baja</option>
            <option value="MEDIUM">Media</option>
            <option value="HIGH">Alta</option>
          </select>
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Product Owner *</span></label>
          <select class="select select-bordered" formControlName="productOwnerId">
            <option value="" disabled>Selecciona</option>
            <option *ngFor="let emp of employees" [value]="emp.id">{{ emp.firstName }} {{ emp.lastName
              }} ({{ emp.role }})
            </option>
          </select>
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Asignado a *</span></label>
          <select class="select select-bordered" formControlName="developerId">
            <option value="0" disabled>Selecciona</option>
            <option *ngFor="let emp of employees" [value]="emp.id">{{ emp.firstName }} {{ emp.lastName
              }} ({{ emp.role }})
            </option>
          </select>
        </div>
      </div>
      <div class="form-control col-span-2">
        <label class="label"><span class="label-text font-medium">Descripción (Criterios de
            Aceptación)</span></label>
        <textarea class="textarea textarea-bordered h-32" formControlName="description"></textarea>
      </div>
      <div class="modal-action">
        <button type="button" class="btn" (click)="closeModal('story_modal')">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop"><button>cerrar</button></form>
</dialog>